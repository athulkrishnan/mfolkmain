(window.Polyer||(window.Polyer={})).Utils={bind:function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,!!d):a.attachEvent("on"+b,c,!!d)},unbind:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c):a.detachEvent("on"+b,c)},addToObject:function(a,b){for(var c in b)a[c]=b[c];return a},cloneObject:function(a){return JSON.parse(JSON.stringify(a))},isPowerOf2:function(a){return 0===(a&a-1)},debounce:function(a,b){var c,d=new Date;return function(){c=new Date,c-d>b&&(d=c,a.apply(this,arguments))}},latestEvent:function(a,b){var c;return function(){var d=this,e=arguments;clearTimeout(c),c=setTimeout(function(){a.apply(d,e)},b)}},createEvent:function(a,b){var c;return Event?c=new Event(a):CustomEvent?c=new CustomEvent(a):document.createEvent?(c=document.createEvent("HTMLEvents"),c.initEvent(a,!0,!0)):(c=document.createEventObject(),c.type=a),this.addToObject(c,b),c},triggerEvent:function(a,b){a.dispatchEvent?a.dispatchEvent(b):a.fireEvent("on"+b.type,b)},trigger:function(a,b,c){this.triggerEvent(a,this.createEvent(b,c))},Observer:function(){function a(){this.targets={},this.callback=null,arguments.length>1&&this.on.apply(this,arguments)}return a.prototype.on=function(){var a,b=Array.prototype.slice.call(arguments,0),c=b.splice(-1,1)[0];for(this.targets={},a=b.length;a--;)this.targets[b[a]]=!1;this.callback=c},a.prototype.emit=function(a){var b;this.targets[a]=!0;for(b in this.targets)if(!this.targets[b])return;for(b in this.targets)this.targets[b]===!0;this.callback()},a}()},(window.Polyer||(window.Polyer={})).UITools={Mask:function(){var a;return{show:function(){a?document.body.appendChild(a):(a=document.createElement("div"),a.id="masklayer",document.body.appendChild(a))},hide:function(){a&&document.body.removeChild(a)}}}(),Alert:function(){function a(){var a=document.createElement("div");return c=document.createElement("div"),e=document.createElement("p"),a.appendChild(document.createElement("div")),a.appendChild(e),a.className="box",c.id="alert-box",c.appendChild(a),c.addEventListener("click",function(){f&&b()}),c}function b(){c&&document.body.removeChild(c),d&&Polyer.UITools.Mask.hide()}var c,d,e,f=!0;return{show:function(b,g,h){document.body.appendChild(c||a()),g&&(Polyer.UITools.Mask.show(),d=!0),f=!h,e.innerHTML=b},hide:b}}()},function(){"use strict";function a(a){this.mode="sync",this.blurKernel=2,this.edgeKernel=2,this.bg="original",this.edit="move",this.vertexNum=4e3,this.meshColor="#00FFFF",this.editBgColor="#444444",this.viewBgColor="#cccccc",this.fillColor="center",this.maxVertexNum=1e4,this.panelClass="",this.panelStyle="",this.delay=30,this.onModeChange=null,this.onUseKernel=null,this.onBgChange=null,this.onEditChange=null,this.onVertexNumChange=null,this.onMeshColorChange=null,this.onEditBgColorChange=null,this.onViewBgColorChange=null,this.onFillColorChange=null,this.zoomLarger=null,this.zoomSmaller=null,this.onImageLoaded=null,this.onSave=null,b(),c(this),a&&this.recovery()}function b(){var a=document.createElement("div"),b='<div id="mode-select" class="clear-fix"><label><div class="panel-bg"></div><p>Edit</p><input type="radio" name="mode" value="edit"></label><label class="checked"><div class="panel-bg"></div><p>Sync</p><input type="radio" name="mode" value="sync" checked></label><label><div class="panel-bg"></div><p>View</p><input type="radio" name="mode" value="view"></label></div><ul><li><p><a>Process</a><span class="circle-icon arrow"></span></p><div id="process"><div><div class="control-box"><p>Blur Size<span class="ques" title="Blur grayed picture , to smooth edge of picture .&#10;&#10;Optimumï¼š 2&#10;&#10;Suggestion:&#10;Adjusting with Edit bg is blured visual for finding a best value&#10;when the picture is smooth enough ."></span></p><div class="slider-box control-content"><div class="slider-bar"></div><div class="slider-points"><div></div><div></div><div></div><div></div><div></div></div><div class="slider-btn" id="blur-size-btn"></div><input class="slider-num" type="text" name="blurKernelSize" value="1" autocomplete="off"></div></div><div class="control-box"><p>Edge Size<span class="ques" title="Detect edge of blured picture .&#10;&#10; Optimum : 1&#10;&#10;Suggestion:&#10;Adjusting with Edit bg is edged visual for finding a best value&#10;when the edge is exactly we want ."></span></p><div class="slider-box control-content"><div class="slider-bar"></div><div class="slider-points"><div></div><div></div><div></div><div></div><div></div></div><div class="slider-btn" id="edge-size-btn"></div><input class="slider-num" type="text" name="edgeKernelSize" value="1" autocomplete="off"></div></div><div class="control-box button-box"><span id="use-kernel-change"><a></a><span>Apply Change</span></span></div><div class="control-box bg-select-box clear-fix"><p>Edit bg</p><div class="bg-options-box" id="bg-select"><label class="checked"><div></div>Original<input type="radio" name="bg-select" value="original" checked></label><label><div></div>Blured<input type="radio" name="bg-select" value="blured"></label><label><div></div>Edged<input type="radio" name="bg-select" value="edged"></label></div></div></div></div></li><li><p><a>Edit</a><span class="circle-icon arrow"></span></p><div id="edit-tools"><div><div class="control-box clear-fix"><p>Vertex</p><div class="control-content"><a class="edit-btn edit-add" value="add"><div class="square-icon add"></div>Add</a><a class="edit-btn edit-rm" value="remove"><div class="square-icon remove"></div>Remove</a><br></div></div><div class="control-box clear-fix"><p>View</p><div class="control-content"><a class="edit-btn edit-move selected" value="move" title="Holding space"><div class="square-icon move"><div></div><div></div></div>Move</a><a class="edit-btn edit-zooml" value="zooml" title="MouseWheel Up"><div class="square-icon zooml"><div></div></div>ZoomL</a><a class="edit-btn edit-zooms" value="zooms" title="MouseWheel Down"><div class="square-icon zooms"><div></div></div>ZoomS</a></div></div><div class="control-box clear-fix"><p>Vs Num<span class="ques" title="The num of vertices producing by edge detection .&#10;All vertices will be reseted after adjustment !"></span></p><div class="slider-box control-content"><div class="slider-bar"></div><div class="slider-btn" id="vertex-num-btn"></div><input class="slider-num" type="text" value="4000" autocomplete="off"></div></div></div></div></li><li><p><a>Colors</a><span class="circle-icon arrow"></span></p><div id="color"><div><div class="control-box"><p>Mesh Color</p><div class="control-content"><a type="meshColor"></a></div></div><div class="control-box"><p>Edit Bg</p><div class="control-content"><a type="editBgColor"></a></div></div><div class="control-box"><p>View Bg</p><div class="control-content"><a type="viewBgColor"></a></div></div><div class="control-box"><p>Fill Color<span class="ques" title="Average:&#10;Fill with the average of colors at three vertices in a Delaunay triangle . &#10;&#10;Center&#10;Fill with the color at the center of a Delaunay triangle ."></span></p><div class="control-content" id="fill-color"><label><input type="radio" name="fillColor"  value="average">Average</label><label><input  type="radio" name="fillColor" value="center" checked>Center</label></div></div></div></div></li></ul><div id="io"><div id="upload" class="button"><input type="file" title="">Upload</div><div id="save" class="button">Save</div></div><div id="mini" class="clear-fix"><a class="edit-btn edit-add" title="Add Vertex" value="add"><span></span></a><a class="edit-btn edit-rm" title="Remove Vertex" value="remove"><span></span></a><a class="edit-btn edit-move selected" title="Move&#10;(Holding Space)" value="move"><span></span></a><a class="edit-btn edit-zooml" title="Zoom Larger&#10;(MouseWheel Up)" value="zooml"><span></span></a><a class="edit-btn edit-zooms" title="Zoom Smaller&#10;(MouseWheel Down)" value="zooms"><span></span></a></div><div id="panel-size" class="circle-icon minimize"></div><div id="panel-move" class="circle-icon move"></div>';a.id="control-panel",a.className="hori top",a.innerHTML=b,p.panel=a,document.body.appendChild(a)}function c(a){d(a),e(a),f(a),g(a),h(a),i(a),j(a),k(),m(a),l(a)}function d(a){for(var b=p.modeInputs=document.getElementById("mode-select").getElementsByTagName("input"),c=b.length;c--;)!function(c){var d=b[c];Polyer.Utils.bind(d,"change",function(){for(var c=b.length;c--;)b[c]!=d&&b[c].parentNode.removeClass("checked");d.parentNode.addClass("checked"),a.mode=d.value,a.store(),o(a.onModeChange,a.mode)})}(c)}function e(a){function b(b,d){var e,f,h,i,j,k,l,m=b,n=m.getSiblingsByClassName("slider-bar")[0],o=d&&m.getSiblingsByClassName("slider-points")[0].getElementsByTagName("div"),p=m.getSiblingsByClassName("slider-num")[0],q=4,r=!1;if(k=d?document.getElementById("process"):document.getElementById("edit-tools"),l=k.style.display,k.style.visibility="hidden",k.style.position="absolute",k.style.display="block",e=parseInt(n.style.left||n.getDefaultStyle("left")),f=e-m.clientWidth/2,h=n.clientWidth+2*parseInt(n.getDefaultStyle("borderLeftWidth")),i=h/q,k.style.display=l,k.style.position="",k.style.visibility="",d)for(var s=o.length;s--;)!function(a){Polyer.Utils.bind(o[a],"click",function(){m.style.left=a*i+f+"px",p.value=a+1,c()})}(s);return Polyer.Utils.bind(p,"keyup",function(b){var e,j=parseInt(p.value);d?(j>q?(Polyer.UITools.Alert.show("Max kernel size is 6"),e=h+f,p.value=q):0>j?(Polyer.UITools.Alert.show("Min kernel size is 0"),e=f,p.value=0):e=(j-1)*i+f,!b.noUpdate&&c(),m.style.left=e+"px"):(j>a.maxVertexNum?(Polyer.UITools.Alert.show("Max number of vertices is"+a.maxVertexNum),e=h+f,p.value=j=a.maxVertexNum):0>j?(Polyer.UItools.Alert.show("Min number of vertices is 0"),e=f,p.value=j=0):e=j*h/a.maxVertexNum+f,g(j),m.style.left=e+"px")}),Polyer.Utils.bind(document,"mousemove",function(b){if(b.preventDefault(),r){b.stopPropagation();var c=parseInt(m.style.left||m.getDefaultStyle("left"))+b.clientX-j;f>c?c=f:c>h+f?c=h+f:j=b.clientX,d||(p.value=(c-f)/h*a.maxVertexNum|0),m.style.left=c+"px"}}),Polyer.Utils.bind(document,"mouseup",function(a){if(a.preventDefault(),r){if(d){var b=parseInt(m.style.left||m.getDefaultStyle("left")),e=Math.round((b-f)/i);b=e*i+f,p.value=e+1,m.style.left=b+"px",c()}else g(parseInt(p.value));r=!1}}),function(a){j=a.clientX,r=!0}}function c(){a.blurKernel=parseInt(d.getSiblingsByClassName("slider-num")[0].value),a.edgeKernel=parseInt(e.getSiblingsByClassName("slider-num")[0].value),a.store()}var d=document.getElementById("blur-size-btn"),e=document.getElementById("edge-size-btn"),f=document.getElementById("vertex-num-btn");p.blurSizeBtn=d,p.edgeSizeBtn=e,p.vertexNumBtn=f,Polyer.Utils.bind(d,"mousedown",b(d,!0)),Polyer.Utils.bind(e,"mousedown",b(e,!0)),Polyer.Utils.bind(f,"mousedown",b(f));var g=Polyer.Utils.latestEvent(function(b){a.vertexNum=b,a.store(),o(a.onVertexNumChange,b)},a.delay)}function f(a){var b=document.getElementById("use-kernel-change");Polyer.Utils.bind(b,"click",function(){o(a.onUseKernel,a.blurKernel,a.edgeKernel)})}function g(a){for(var b=p.bgInputs=document.getElementById("bg-select").getElementsByTagName("input"),c=b.length;c--;)!function(c){var d=b[c];Polyer.Utils.bind(d,"change",function(){for(var c=b.length;c--;)b[c]!=d&&b[c].parentNode.removeClass("checked");d.parentNode.addClass("checked"),a.bg=d.value,a.store(),o(a.onBgChange,a.bg)})}(c)}function h(a){for(var b=document.getElementById("edit-tools"),c=document.getElementById("mini").getElementsByTagName("a"),d=b.getElementsByTagName("a"),e=3;e--;)!function(b){function e(){for(var e=3;e--;)c[e].removeClass("selected"),d[e].removeClass("selected");c[b].addClass("selected"),d[b].addClass("selected"),a.edit=c[b].getAttribute("value"),o(a.onEditChange,a.edit)}Polyer.Utils.bind(c[b],"click",e),Polyer.Utils.bind(d[b],"click",e)}(e);for(e=3;5>e;e++)!function(b){function e(){o("zooml"==c[b].getAttribute("value")?a.zoomLarger:a.zoomSmaller)}Polyer.Utils.bind(c[b],"click",e),Polyer.Utils.bind(d[b],"click",e)}(e)}function i(a){function b(a){a.preventDefault(),d.parentNode.removeChild(f),Polyer.Utils.unbind(document,"click",b)}function c(){for(var c=document.createElement("div"),e=[["#000000","#444444","#666666","#999999","#cccccc","#eeeeee","#f3f3f3","#ffffff"],["#ff0000","#ff9900","#ffff00","#00ff00","#00ffff","#0000ff","#9900ff","#ff00ff"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#cc0000","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#990000","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#660000","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],f=15,g=2,h=f+2*g,i=0;i<e.length;i++){for(var j=document.createElement("div"),k=0;k<e.length;k++){var l=document.createElement("div");l.style.background=e[i][k],j.appendChild(l)}j.className="clear-fix",c.appendChild(j)}return c.id="color-list",c.style.width=c.style.height=h*e.length+"px",Polyer.Utils.bind(c,"click",function(f){f.stopPropagation();var i=f.layerX||f.offsetX,j=f.layerY||f.offsetY,k=i/h|0,l=j/h|0;if(i>k*h+g&&(k+1)*h-g>i&&j>l*h+g&&(l+1)*h-g>j){switch(d.style.background=e[l][k],d.parentNode.removeChild(c),d.getAttribute("type")){case"meshColor":a.meshColor=e[l][k],o(a.onMeshColorChange,a.meshColor);break;case"editBgColor":a.editBgColor=e[l][k],o(a.onEditBgColorChange,a.editBgColor);break;case"viewBgColor":a.viewBgColor=e[l][k],o(a.onViewBgColorChange,a.viewBgColor)}a.store(),Polyer.Utils.unbind(document,"click",b)}}),c}for(var d,e=p.colorAs=document.getElementById("color").getElementsByTagName("a"),f=c(),g=e.length;g--;)!function(a){Polyer.Utils.bind(a,"click",function(c){c.preventDefault(),c.stopPropagation(),d=a,a.parentNode.appendChild(f),f.style.left=a.clientWidth+a.offsetLeft+5+"px",f.style.top=a.offsetTop+"px",Polyer.Utils.bind(document,"click",b)})}(e[g])}function j(a){function b(b){var c=b.target||b.srcElement;a.fillColor=c.value,a.store(),o(a.onFillColorChange,a.fillColor)}for(var c=p.fillColorInputs=document.getElementById("fill-color").getElementsByTagName("input"),d=c.length;d--;)Polyer.Utils.bind(c[d],"change",b)}function k(){for(var a=document.getElementById("process"),b=document.getElementById("edit-tools"),c=document.getElementById("color"),d=[a,b,c],e=3;e--;)!function(a){Polyer.Utils.bind(a.getPrevious().getElementsByTagName("span")[0],"click",function(b){var c=b.target||b.srcElement;c.hasClass("open")?(c.removeClass("open"),a.style.display="none"):(c.addClass("open"),a.style.display="block")})}(d[e])}function l(a){var b=document.getElementById("control-panel"),c=document.getElementById("panel-size"),d=document.getElementById("panel-move");p.panelSizeBtn=c,Polyer.Utils.bind(c,"click",function(d){b.toggleClass("mini"),c.toggleClass("minimize"),c.toggleClass("normalize"),n(b),a.panelClass=p.panel.className,a.store()}),Polyer.Utils.bind(window,"resize",Polyer.Utils.debounce(function(a){a.preventDefault(),n(b)},100)),Polyer.Utils.bind(d,"mousedown",Polyer.Utils.debounce(function(){var c=!1,d={x:0,y:0};return Polyer.Utils.bind(document,"mousemove",function(a){a.preventDefault(),c&&(a.stopPropagation(),b.style.left=parseInt(b.style.left||b.getDefaultStyle("left"))+a.clientX-d.x+"px",b.style.top=parseInt(b.style.top||b.getDefaultStyle("top"))+a.clientY-d.y+"px",d.x=a.clientX,d.y=a.clientY)}),Polyer.Utils.bind(document,"mouseup",function(d){d.preventDefault(),c=!1,n(b),a.panelClass=b.className,a.panelStyle=b.style.cssText,a.store()}),function(a){d.x=a.clientX,d.y=a.clientY,c=!0}}(),30))}function m(a){function b(a){a.preventDefault()}function c(b){var c=new FileReader;-1==b.type.indexOf("image")?Polyer.UITools.Alert.show("Upload file is not a Image file !"):(Polyer.UITools.Alert.show("Uploading...",!0,!0),c.onload=function(b){var c=new Image;c.onload=function(){o(a.onImageLoaded,c)},c.src=b.target.result,Polyer.UITools.Alert.hide()},c.readAsDataURL(b))}var d,e=document.getElementById("upload"),f=document.getElementById("save"),g=e.getChildrenByTagName("input")[0];Polyer.Utils.bind(e,"click",function(){g.click()}),Polyer.Utils.bind(g,"change",function(){c(g.files[0])}),Polyer.Utils.bind(f,"click",function(){d?Polyer.UITools.Mask.show():(d=document.createElement("div"),d.id="save-box",d.innerHTML='<div class="box"><img src=""></div><p>Right click on image to save it</p><div class="circle-icon close"></div>',Polyer.UITools.Mask.show(),Polyer.Utils.bind(d.getChildrenByClassName("close")[0],"click",function(){document.body.removeChild(d),Polyer.UITools.Mask.hide()})),document.body.appendChild(d),o(a.onSave,d.getElementsByTagName("img")[0])}),Polyer.Utils.bind(document,"dragover",b),Polyer.Utils.bind(document,"dragleave",b),Polyer.Utils.bind(document,"drop",function(a){a.preventDefault(),c(a.dataTransfer.files[0])})}function n(a){var b=!1,c=parseInt(a.style.left||a.getDefaultStyle("left")),d=parseInt(a.style.top||a.getDefaultStyle("top"));100>c?(a.removeClass("hori"),a.style.left="0px",b=!0):c>document.body.clientWidth-a.clientWidth-100&&(a.removeClass("hori"),a.style.left=document.body.clientWidth-a.clientWidth+"px",b=!0),100>d?(!b&&a.addClass("hori"),a.removeClass("bottom").addClass("top"),a.style.top="0px",a.clientWidth+parseInt(a.style.left)>document.body.clientWidth&&(a.hasClass("mini")||panel_size.click())):d>document.body.clientHeight-a.clientHeight-100?(!b&&a.addClass("hori"),a.removeClass("top").addClass("bottom"),a.style.top=document.body.clientHeight-a.clientHeight+"px",a.clientWidth+parseInt(a.style.left)>document.body.clientWidth&&(a.hasClass("mini")||panel_size.click())):a.removeClass("top").removeClass("bottom")}function o(a){a&&a.constructor===Function&&a.apply(null,Array.prototype.slice.call(arguments,1))}Element.prototype.getPrevious=function(){for(var a=this.previousSibling;1!=a.nodeType;)a=a.previousSibling;return a},Element.prototype.getSiblingsByClassName=function(a){var b;for(a=this.parentNode.getChildrenByClassName(a),b=a.length;b--;)a[b]===this&&a.splice(b,1);return a},Element.prototype.getChildrenByTagName=function(a){for(var b=this.childNodes,c=[],d=0,e=b.length;e>d;)1==b[d].nodeType&&b[d].tagName==a.toUpperCase()&&c.push(b[d]),d++;return c},Element.prototype.getChildrenByClassName=function(a){for(var b=this.childNodes,c=[],d=0,e=b.length,f=new RegExp(a);e>d;)1==b[d].nodeType&&-1!=b[d].className.search(f)&&c.push(b[d]),d++;return c},Element.prototype.hasClass=function(a){return-1!=this.className.search(new RegExp("\\b"+a+"\\b"))},Element.prototype.addClass=function(a){return!this.hasClass(a)&&(this.className+=" "+a),this},Element.prototype.removeClass=function(a){return this.hasClass(a)&&(this.className=this.className.replace(new RegExp("(\\s|^)"+a+"(\\s|$)")," ").replace(/\s+/g," ")),this},Element.prototype.toggleClass=function(a){return this.hasClass(a)?this.removeClass(a):this.addClass(a),this},Element.prototype.getDefaultStyle=function(a){return this.currentStyle?this.currentStyle[a]:document.defaultView.getComputedStyle(this,!1)[a]};var p={};a.prototype.toString=function(){var a={};for(var b in this)null!==this[b]&&this[b].constructor!=Function&&(a[b]=this[b]);return JSON.stringify(a)},a.prototype.store=function(){window.localStorage&&window.localStorage.setItem("PolyerPanel",this.toString())},a.prototype.recovery=function(){var a,b;if(window.localStorage){a=window.localStorage.getItem("PolyerPanel"),a=JSON.parse(a);for(b in a)this[b]=a[b];this.edit="move",this.maxVertexNum=1e4,this.updateUIs()}},a.prototype.recoverySingle=function(a){var b;window.localStorage&&(b=window.localStorage.getItem("PolyerPanel"),b=JSON.parse(b),this[a]&&(this[a]=b[a],this.updateSingleUI(a)))},a.prototype.clear=function(){window.localStorage&&window.localStorage.removeItem("PolyerPanel")},a.prototype.updateUIs=function(){for(var a in this)null!==this[a]&&this[a].constructor!==Function&&this.updateSingleUI(a)},a.prototype.updateSingleUI=function(a){function b(b,c,e){var f;if(b){for(f=c.length;f--;)if(c[f].getAttribute("type")==a){e(c[f]);break}}else for(f=c.length;f--;)if(c[f].value==d[a]){e(c[f]);break}}var c,d=this;switch(a){case"panelClass":p.panel.className=d[a],p.panel.removeClass("top").removeClass("bottom"),p.panel.hasClass("mini")?p.panelSizeBtn.removeClass("minimize").addClass("normalize"):p.panelSizeBtn.removeClass("normalize").addClass("minimize");break;case"panelStyle":p.panel.style.cssText=d[a],n(p.panel);break;case"mode":b(!1,p.modeInputs,function(a){a.checked=!0,Polyer.Utils.trigger(a,"change")});break;case"vertexNum":c=p.vertexNumBtn.getSiblingsByClassName("slider-num")[0],c.value=d[a],Polyer.Utils.trigger(c,"keyup");break;case"bg":b(!1,p.bgInputs,function(a){a.checked=!0,Polyer.Utils.trigger(a,"change")});break;case"meshColor":b(!0,p.colorAs,function(b){b.style.background=d[a],o(d.onMeshColorChange,d[a])});break;case"editBgColor":b(!0,p.colorAs,function(b){b.style.background=d[a],o(d.onEditBgColorChange,d[a])});break;case"viewBgColor":b(!0,p.colorAs,function(b){b.style.background=d[a],o(d.onViewBgColorChange,d[a])});break;case"fillColor":b(!1,p.fillColorInputs,function(a){a.checked=!0,Polyer.Utils.trigger(a,"change")})}},(window.Polyer||(window.Polyer={})).Panel=a}(),function(){"use strict";function a(a){var f,g,h,i,j,k,l,m,n,o;if((f=a.length)<3)return[];for(a=a.concat(),g=f,i=new Array(f);g--;)i[g]=g;for(i.sort(function(b,c){return a[c][0]-a[b][0]}),j=b(a),a.push(j[0],j[1],j[2]),k=[c(a,f+0,f+1,f+2)],l=[],j=[],g=i.length;g--;j.length=0){for(m=i[g],h=k.length;h--;)n=a[m][0]-k[h].x,n>0&&n*n>k[h].r?(l.push(k[h]),k.splice(h,1)):(o=a[m][1]-k[h].y,n*n+o*o-k[h].r>e||(j.push(k[h].i,k[h].j,k[h].j,k[h].k,k[h].k,k[h].i),k.splice(h,1)));for(d(j),h=j.length;h;)k.push(c(a,j[--h],j[--h],m))}for(g=k.length;g--;)l.push(k[g]);for(k.length=0,g=l.length;g--;)l[g].i<f&&l[g].j<f&&l[g].k<f&&k.push(l[g].i,l[g].j,l[g].k);return k}function b(a){var b,c,d,e,f=Number.POSITIVE_INFINITY,g=f,h=0,i=0;for(b=a.length;b--;)a[b][0]<f&&(f=a[b][0]),a[b][0]>i&&(i=a[b][0]),a[b][1]<g&&(g=a[b][1]),a[b][1]>h&&(h=a[b][1]);return c=i-f,d=h-g,e=c/2,[[f-e-2,h+1],[f+e,g-d],[i+e+2,h+1]]}function c(a,b,c,d){var f,g,h,i,j,k,l,m,n,o,p=a[b][0],q=a[b][1],r=a[c][0],s=a[c][1],t=a[d][0],u=a[d][1],v=Math.abs(q-s),w=Math.abs(s-u);return e>v?(i=-((t-r)/(u-s)),k=(r+t)/2,m=(s+u)/2,f=(r+p)/2,g=i*(f-k)+m):e>w?(h=-((r-p)/(s-q)),j=(p+r)/2,l=(q+s)/2,f=(t+r)/2,g=h*(f-j)+l):(h=-((r-p)/(s-q)),i=-((t-r)/(u-s)),j=(p+r)/2,k=(r+t)/2,l=(q+s)/2,m=(s+u)/2,f=(h*j-i*k+m-l)/(h-i),g=v>w?h*(f-j)+l:i*(f-k)+m),n=r-f,o=s-g,{i:b,j:c,k:d,x:f,y:g,r:n*n+o*o}}function d(a){var b,c,d,e,f,g;for(c=a.length;c;)for(e=a[--c],d=a[--c],b=c;b;)if(g=a[--b],f=a[--b],d===f&&e===g||d===g&&e===f){a.splice(c,2),a.splice(b,2);break}}var e=Number.EPSILON||Math.pow(2,-52);(window.Polyer||(window.Polyer={})).Delaunay=a}(),function(a){"use strict";function b(a,b){try{return a.getContext("experimental-webgl",b)}catch(c){console.error("Error creating WebGL"+c.toString())}}function c(a){a.gl.viewport(0,0,a.canvas.width,a.canvas.height)}function d(a,b,c){var d,e=a.gl;return"fragment"==c?d=e.createShader(e.FRAGMENT_SHADER):"vertex"==c&&(d=e.createShader(e.VERTEX_SHADER)),e.shaderSource(d,b),e.compileShader(d),e.getShaderParameter(d,e.COMPILE_STATUS)?d:console.error(e.getShaderInfoLog(d))}function e(a,b){var c=a.gl,e=d(a,b.vertex,"vertex"),f=d(a,b.fragment,"fragment"),g=b.program=c.createProgram();return b.attributes||(b.attributes={}),b.uniforms||(b.uniforms={}),c.attachShader(g,f),c.attachShader(g,e),c.linkProgram(g),c.getProgramParameter(g,c.LINK_STATUS)||console.error("Could not initialise shaders"),a.setCurrentProgram(g),g}function f(a,b,c,d){var e=a.canvas,f=c/d;e.width/e.height>f?(b[0]=b[6]=-c/d*e.height/e.width,b[3]=b[9]=c/d*e.height/e.width,b[1]=b[4]=1,b[7]=b[10]=-1):(b[0]=b[6]=-1,b[3]=b[9]=1,b[1]=b[4]=d/c*e.width/e.height,b[7]=b[10]=-d/c*e.width/e.height),a.setTextureSize(!1,b[3],b[1])}function g(a,b,c,d){var e,f=a.gl,g=a.getCurrentProgram();for(e in b)d||(b[e].handler=f.getAttribLocation(g,e)),h(a,b[e]);for(e in c)d||(c[e].handler=f.getUniformLocation(g,e)),i(a,c[e])}function h(a,b){var c=a.gl,d=b.buffer;switch(b.type){case"float":c.bindBuffer(c.ARRAY_BUFFER,c.createBuffer()),c.bufferData(c.ARRAY_BUFFER,new Float32Array(d[0]),b.bufferUsage||c.STATIC_DRAW),c.enableVertexAttribArray(b.handler),c.vertexAttribPointer(b.handler,b.size,c.FLOAT,!1,0,0)}}function i(a,b){var c=a.gl,d=b.buffer;switch(b.type){case"bool":case"float":c.uniform1f(b.handler,d[0]);break;case"vec2":c.uniform2f(b.handler,d[0],d[1]);break;case"vec3":c.uniform3f(b.handler,d[0],d[1],d[2]);break;case"vec4":c.uniform4f(b.handler,d[0],d[1],d[2],d[3]);break;case"mat4":c.uniformMatrix4fv(b.handler,!1,d[0]);break;case"sampler2D":c.uniform1i(b.handler,d[0])}}function j(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p=a.canvas,q=[],r=[],s=p.width/p.height>e/f;for(k=0,l=0,m=0,n=0,o=0,i=0;i<d.length;i++)if(s?r.push((2*b[d[i]][0]-e)/f*p.height/p.width,1-b[d[i]][1]/f*2,0):r.push(b[d[i]][0]/e*2-1,(f-2*b[d[i]][1])/e*p.width/p.height,0),g){if(h=(f-b[d[i]][1])*e*4+4*b[d[i]][0],m+=c[h]/255,n+=c[h+1]/255,o+=c[h+2]/255,(i+1)%3===0){for(j=0;3>j;j++)q.push(m/3,n/3,o/3);m=0,n=0,o=0}}else if(k+=b[d[i]][0],l+=b[d[i]][1],(i+1)%3===0){for(h=(f-l/3|0)*e*4+4*(k/3|0),j=0;3>j;j++)q.push(c[h]/255,c[h+1]/255,c[h+2]/255);k=0,l=0}return{triangles:r,colors:q}}function k(a,b){var c=a.getPolyPoints(),d=a.getDelaunayTriangles(),e=a.getTextureSize(),f=a.getOriginalColors();return j(a,c,f,d,e.width,e.height,b)}function l(a,b,c,d){var e,f=a.canvas,g=[],h=f.width/f.height,i=h>c/d;for(e=b.length;e--;)i?g.push((2*b[e][0]-c)/d/h,1-b[e][1]/d*2,0):g.push(b[e][0]/c*2-1,(d-2*b[e][1])/c*h,0);return g}function m(a,b,c,d,e){var f,g,h,i=a.canvas,j=[],k=i.width/i.height,l=k>d/e,m=[0,1,1,2,2,0];try{for(f=0;f<c.length;f+=3)for(g=0;6>g;g++)h=c[f+m[g]],l?j.push((2*b[h][0]-d)/e/k,1-b[h][1]/e*2,0):j.push(b[h][0]/d*2-1,(e-2*b[h][1])/d*k,0)}catch(n){return j}return j}function n(a,b,c){var d=a.canvas;return{x:-(d.width-2*b)/d.width,y:(d.height-2*c)/d.height}}function o(a,b,c){var d=a.getCameraMatrix();return{x:(b-d[12])/d[0],y:(c-d[13])/d[5]}}function p(a,b,c){var d=n(a,b,c);return o(a,d.x,d.y)}function q(a,b,c,d){var e=a.getTextureSize();return!d&&(Math.abs(b)>e.xmax||Math.abs(c)>e.ymax)?!1:{x:(b/e.xmax+1)*e.width/2|0,y:(-c/e.ymax+1)*e.height/2|0}}function r(a){var b=a.gl,c=b.createTexture();return b.bindTexture(b.TEXTURE_2D,c),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),c}function s(a,b,c){var d=a.gl,e=new Uint8Array(b*c*4);return d.readPixels(0,0,b,c,d.RGBA,d.UNSIGNED_BYTE,e),e}function t(a,b,c,d){var e,f,g,h=s(a,b,c),i=[];for(e=b;--e;)for(f=c;--f;)g=4*(f*b+e),h[g]<122&&h[g+1]<122&&h[g+2]<122&&i.push([e,f]);return d&&"number"==typeof d?w(i,d):i}function u(a,b,d,h,i){var j,k,l,m,n,o,p,q=a.gl,u=a.getOriginalObject(),v=[],w=[],x=a.getBaseShader(),y={vertex:G.Shaders.common.vsWithoutCamera,fragment:null,attributes:{},uniforms:{}},z={attributes:{position:"vec4",uv:"vec2"},uniforms:{textureSize:"vec2"}};for(A(a,y,z),a.setTextureSize(!0,b.width,b.height),y.uniforms.textureSize=Polyer.Utils.addToObject(Polyer.Utils.cloneObject(G.Shaders.baseArgs.uniforms.textureSize),{buffer:[b.width,b.height]}),d.push({type:"show"}),j=r(a),q.texImage2D(q.TEXTURE_2D,0,q.RGBA,q.RGBA,q.UNSIGNED_BYTE,b),k=r(a),q.texImage2D(q.TEXTURE_2D,0,q.RGBA,b.width,b.height,0,q.RGBA,q.UNSIGNED_BYTE,null),l=r(a),q.texImage2D(q.TEXTURE_2D,0,q.RGBA,b.width,b.height,0,q.RGBA,q.UNSIGNED_BYTE,null),a.getTextures().original=j,p=0;2>p;p++){var B=r(a);w.push(B),q.texImage2D(q.TEXTURE_2D,0,q.RGBA,b.width,b.height,0,q.RGBA,q.UNSIGNED_BYTE,null);var C=q.createFramebuffer();v.push(C),q.bindFramebuffer(q.FRAMEBUFFER,C),q.framebufferTexture2D(q.FRAMEBUFFER,q.COLOR_ATTACHMENT0,q.TEXTURE_2D,B,0)}for(q.bindTexture(q.TEXTURE_2D,j),q.viewport(0,0,b.width,b.height),d.unshift({type:"show"}),p=0;p<d.length;p++)("blur"==d[p].type||"edge"==d[p].type||p+1==d.length&&p%2===0)&&(d.splice(p,0,{type:"show"}),p++);for(p=0;p<d.length;p++){switch(m=d[p].kernelSize?d[p].kernelSize:5,d[p].type){case"show":case"gray":a.setCurrentProgram(x[d[p].type].program),o=x[d[p].type].handlers.uniforms,o.cameraMatrix&&(o.cameraMatrix.buffer[0]=G.Shaders.baseArgs.uniforms.cameraMatrix.buffer[0].slice(0)),g(a,x[d[p].type].handlers.attributes,o);break;case"blur":case"edge":Polyer.Utils.addToObject(y,{fragment:G.Shaders.produceKernelFs(d[p].type,m)}),e(a,y),g(a,y.attributes,y.uniforms)}q.bindFramebuffer(q.FRAMEBUFFER,v[p%2]),q.viewport(0,0,b.width,b.height),q.drawArrays(q.TRIANGLE_STRIP,0,4),0===p&&a.setOriginalColors(s(a,b.width,b.height)),"edge"==d[p].type?(q.bindTexture(q.TEXTURE_2D,l),q.copyTexSubImage2D(q.TEXTURE_2D,0,0,0,0,0,b.width,b.height),q.bindTexture(q.TEXTURE_2D,w[p%2]),a.getTextures().edged=l):"blur"==d[p].type&&(q.bindTexture(q.TEXTURE_2D,k),q.copyTexSubImage2D(q.TEXTURE_2D,0,0,0,0,0,b.width,b.height),q.bindTexture(q.TEXTURE_2D,w[p%2]),a.getTextures().blured=k),q.bindTexture(q.TEXTURE_2D,w[p%2])}a.setEdgePoints(t(a,b.width,b.height)),q.bindTexture(q.TEXTURE_2D,a.getTextures().original),u?f(a,u.shader.handlers.attributes.position.buffer[0],b.width,b.height):(n=Polyer.Utils.cloneObject(x.show.handlers),f(a,n.attributes.position.buffer[0],b.width,b.height),a.setCurrentProgram(x.show.program),g(a,n.attributes,n.uniforms),a.addToScene(u={type:q.TRIANGLE_STRIP,number:4,shader:{program:x.show.program,handlers:n}}),a.setOriginalObject(u)),q.bindFramebuffer(q.FRAMEBUFFER,null),c(a),a.setPolyPointsFromEdge("undefined"==typeof h?4e3:h),i()}function v(a,b,d){var e,h,i,j=a.gl,k=a.getBaseShader().show,l=a.getOriginalObject(),m=Polyer.Utils.cloneObject(k.handlers);h=r(a),j.texImage2D(j.TEXTURE_2D,0,j.RGBA,j.RGBA,j.UNSIGNED_BYTE,b),a.getTextures().original=h,a.setTextureSize(!0,b.width,b.height),a.setCurrentProgram(k.program),m.uniforms.cameraMatrix.buffer[0]=G.Shaders.baseArgs.uniforms.cameraMatrix.buffer[0].slice(0),g(a,m.attributes,m.uniforms),e=r(a),j.texImage2D(j.TEXTURE_2D,0,j.RGBA,b.width,b.height,0,j.RGBA,j.UNSIGNED_BYTE,null),i=j.createFramebuffer(),j.bindFramebuffer(j.FRAMEBUFFER,i),j.framebufferTexture2D(j.FRAMEBUFFER,j.COLOR_ATTACHMENT0,j.TEXTURE_2D,e,0),j.bindTexture(j.TEXTURE_2D,h),j.viewport(0,0,b.width,b.height),j.drawArrays(j.TRIANGLE_STRIP,0,4),a.setOriginalColors(s(a,b.width,b.height)),j.bindFramebuffer(j.FRAMEBUFFER,null),c(a),l?f(a,l.shader.handlers.attributes.position.buffer[0],b.width,b.height):(f(a,m.attributes.position.buffer[0],b.width,b.height),a.addToScene(l={type:j.TRIANGLE_STRIP,number:4,shader:{program:k.program,handlers:m}}),a.setOriginalObject(l)),d()}function w(a,b){var c,d,e,f=[];for(0>b&&(b=0),b>a.length&&(b=a.length),a=a.slice(0),e=a.length,c=b;c--;)d=e*Math.random()|0,f.push(a[d]),a.splice(d,1),e--;return f}function x(a,b){var c=new Image;return c.onload=function(){b.apply(this,arguments)},c.src=a,c}function y(a,b){var c,d=a.gl;c=x(b.src,function(){r(a);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,c),a.setTextureSize(!0,c.width,c.height),b.callback()})}function z(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function A(a,b,c){var d;for(d in c.attributes)b.attributes[d]=Polyer.Utils.cloneObject(G.Shaders.baseArgs.attributes[d]);for(d in c.uniforms)b.uniforms[d]=Polyer.Utils.cloneObject(G.Shaders.baseArgs.uniforms[d]),"cameraMatrix"==d&&(b.uniforms.cameraMatrix.buffer[0]=a.getCameraMatrix())}function B(a){var b,c,d,f=a.getBaseShader();for(d in f)b={vertex:G.Shaders[d].vs,fragment:G.Shaders[d].fs,attributes:{},uniforms:{}},c=G.Shaders[d].handlers,A(a,b,c),f[d].program=e(a,b),f[d].handlers={attributes:b.attributes,uniforms:b.uniforms}}function C(a){var b=Polyer.Utils.debounce(function(b){(b.detail?b.detail<0:b.wheelDelta>0)?a.zoom(-.22,-.22):a.zoom(.22,.22)},20);Polyer.Utils.bind(a.canvas,"mousewheel",b),Polyer.Utils.bind(a.canvas,"DOMMouseScroll",b)}function D(a){
var b=a.canvas,c={isLock:!0,x:0,y:0};Polyer.Utils.bind(b,"mousedown",function(a){c.isLock=!1,c.x=a.pageX||a.clientX,c.y=a.pageY||a.clientY}),Polyer.Utils.bind(b,"mousemove",Polyer.Utils.debounce(function(d){c.isLock||(b.style.cursor="move",a.drag(((d.pageX||d.clientX)-c.x)/b.width*2,((d.pageY||d.clientY)-c.y)/b.height*2),c.x=d.pageX||d.clientX,c.y=d.pageY||d.clientY)},20)),Polyer.Utils.bind(b,"mouseout",function(){b.style.cursor="default",c.isLock=!0}),Polyer.Utils.bind(b,"mouseup",function(){b.style.cursor="default",c.isLock=!0})}function E(a){var b=a.canvas;Polyer.Utils.bind(b,"click",function(b){var c,d=a.getPolyPoints();(c=a.convertCoorIntoTexture(b.offsetX,b.offsetY))&&(d.push([c.x,c.y]),a.updatePolyMeshBasePoints(),a.draw())})}function F(b){Polyer.Utils.bind(a,"resize",function(){b.resize(document.body.clientWidth,document.body.clientHeight),b.draw()})}function G(a,d){this.canvas=a,this.clearColor=[1,0,0,1],this.gl=b(this.canvas,d);var e,f,g,h,i,j,k,l,m,n=[],o={original:null,blured:null,edged:null},p={show:{},gray:{},"final":{},mesh:{},select:{}},q=[],r={width:0,height:0,xmax:0,ymax:0},s=[],t=[];c(this),g=z(),this.getScenes=function(){return n},this.getOriginalImage=function(){return e},this.setOriginalImage=function(a){e=a},this.getTextures=function(){return o},this.getOriginalColors=function(){return f},this.setOriginalColors=function(a){f=a},this.getCameraMatrix=function(){return g},this.getCurrentProgram=function(){return h},this.setCurrentProgram=function(a){this.gl.useProgram(a),h=a},this.getBaseShader=function(){return p},this.setEdgePoints=function(a){q=a},this.getEdgePoints=function(){return q},this.getTextureSize=function(){return r},this.setTextureSize=function(a,b,c){a?(r.width=b,r.height=c):(r.xmax=b,r.ymax=c)},this.getPolyPoints=function(){return s},this.setPolyPoints=function(a){s=a},this.getDelaunayTriangles=function(){return t},this.setDelaunayTriangles=function(a){t=a},this.getOriginalObject=function(){return i},this.setOriginalObject=function(a){i=a},this.getPolyTriangleObject=function(){return j},this.setPolyTriangleObject=function(a){j=a},this.getPolyMeshObject=function(){return k},this.setPolyMeshObject=function(a){k=a},this.getPolyPointObject=function(){return l},this.setPolyPointObject=function(a){l=a},this.getSelectObject=function(){return m},this.setSelectObject=function(a){m=a},B(this)}G.prototype.setClearColor=function(a){this.clearColor=a,this.gl.clearColor.apply(this.gl,this.clearColor)},G.prototype.addToScene=function(a){this.getScenes().push(a)},G.prototype.popFromScene=function(){this.getScenes().pop()},G.prototype.createProcessingLine=function(a,b,c,d){var e,f=this;a.constructor===Image||a.constructor===HTMLImageElement?(e=a,u(f,e,b,c,d)):e=x(a,function(){u(f,e,b,c,d)}),this.setOriginalImage(e)},G.prototype.reProcessLine=function(a,b,c){var d=this.getOriginalImage();u(this,d,a,b,c)},G.prototype.setBackground=function(a){var b=this.gl,c=this.getTextures();c[a]&&b.bindTexture(b.TEXTURE_2D,c[a])},G.prototype.createOriginal=function(a,b){var c,d=this;a.constructor===Image||a.constructor===HTMLImageElement?(c=a,v(d,c,b)):c=x(a,function(){v(d,c,b)}),this.setOriginalImage(c)},G.prototype.poly=function(a,b,c){this.setPolyPointsFromEdge(a,b),this.setDelaunayTriangles(Polyer.Delaunay(this.getPolyPoints())),this.createPolyTriangle(c)},G.prototype.setPolyPointsFromEdge=function(a,b){var c="number"==typeof a?w(this.getEdgePoints(),a):this.getEdgePoints(),d=this.getTextureSize();return b&&c.push([0,0],[d.width,0],[0,d.height],[d.width,d.height]),this.setPolyPoints(c)},G.prototype.createPolyTriangle=function(a){var b,c,d=this.gl,e=this.getBaseShader()["final"],f=k(this,a);return c=Polyer.Utils.cloneObject(e.handlers),c.attributes.position.buffer[0]=f.triangles,c.attributes.color.buffer[0]=f.colors,this.setCurrentProgram(e.program),g(this,c.attributes,c.uniforms),this.setPolyTriangleObject(b={type:d.TRIANGLES,number:f.triangles.length/3,shader:{program:e.program,handlers:c}}),this.addToScene(b),b},G.prototype.updatePolyTriangle=function(a){var b=this.getPolyTriangleObject()||this.createPolyTriangle(),c=k(this,a);b.shader.handlers.attributes.position.buffer[0]=c.triangles,b.shader.handlers.attributes.color.buffer[0]=c.colors,b.number=c.triangles.length/3},G.prototype.createPolyMesh=function(a){var b,c,d=this.gl,e=this.getPolyPoints(),f=this.getTextureSize(),h=Polyer.Delaunay(e),i=m(this,e,h,f.width,f.height),j=l(this,e,f.width,f.height),k=this.getBaseShader().mesh,n=Polyer.Utils.cloneObject(k.handlers),o=Polyer.Utils.cloneObject(k.handlers);return this.setDelaunayTriangles(h),n.attributes.position.buffer=[i],n.attributes.position.bufferUsage=d.DYNAMIC_DRAW,n.uniforms.meshColor.buffer=a||[0,0,0],n.uniforms.isPoint.buffer[0]=!1,this.setCurrentProgram(k.program),g(this,n.attributes,n.uniforms),this.setPolyMeshObject(b={type:d.LINES,number:2*h.length,shader:{program:k.program,handlers:n}}),o.attributes.position.buffer=[j],o.attributes.position.bufferUsage=d.DYNAMIC_DRAW,o.uniforms.meshColor.buffer=a||[0,0,0],o.uniforms.isPoint.buffer[0]=!0,this.setCurrentProgram(k.program),g(this,o.attributes,o.uniforms),this.setPolyPointObject(c={type:d.POINTS,number:e.length,shader:{program:k.program,handlers:o}}),this.addToScene(b),this.addToScene(c),b},G.prototype.updatePolyMeshBasePoints=function(){var a,b,c=this.getPolyMeshObject()||(this.setPolyPoints(this.getPolyPoints().splice(-1)),this.createPolyMesh()),d=this.getPolyPoints(),e=this.getPolyPointObject(),f=this.getTextureSize(),g=Polyer.Delaunay(d);this.setDelaunayTriangles(g),a=m(this,d,g,f.width,f.height),c.number=a.length/3,c.shader.handlers.attributes.position.buffer[0]=a,b=l(this,d,f.width,f.height),e.number=d.length,e.shader.handlers.attributes.position.buffer[0]=b},G.prototype.updatePolyMeshColor=function(a){var b=this.getPolyMeshObject(),c=this.getPolyPointObject();b.shader.handlers.uniforms.meshColor.buffer=c.shader.handlers.uniforms.meshColor.buffer=a},G.prototype.createCustomShader=function(a){var b={};return b.program=e(this,a),b.handlers={attributes:a.attributes,uniforms:a.uniforms},b.texture=a.texture,a.texture&&y(this,a.texture),b},G.prototype.linkObjectAndShader=function(a,b){var c=this;if(b.handlers.attributes.position=b.handlers.attributes.position||{type:"float",size:a.size,buffer:[a.array]},b.handlers.uniforms.cameraMatrix=b.handlers.uniforms.cameraMatrix||{type:"mat4",buffer:[c.getCameraMatrix()]},b.texture){var d=b.texture.callback,e=c.getTextureSize();b.handlers.uniforms.textureSize=b.handlers.uniforms.textureSize||{type:"vec2",buffer:[null]},b.texture.callback=function(){f(c,a.array,e.width,e.height),b.handlers.uniforms.textureSize.buffer&&(b.handlers.uniforms.textureSize.buffer[0]=[e.width,e.height]),g(c,b.handlers.attributes,b.handlers.uniforms),d&&d()}}else g(c,b.handlers.attributes,b.handlers.uniforms);return{type:a.type,number:a.number,shader:{program:b.program,handlers:b.handlers}}},G.prototype.createAndAddToScene=function(a,b){this.addToScene(this.linkObjectAndShader(a,b))},G.prototype.createSquare=function(){var a=this.gl,b=this.canvas.height/this.canvas.width,c=[b,1,0,-b,1,0,b,-1,0,-b,-1,0];return{number:4,type:a.TRIANGLE_STRIP,array:c,size:3}},G.prototype.convertCoorIntoTexture=function(a,b,c){var d=p(this,a,b);return q(this,d.x,d.y,c)},G.prototype.drawObject=function(a){var b=this.gl;if(this.setCurrentProgram(a.shader.program),g(this,a.shader.handlers.attributes,a.shader.handlers.uniforms,!0),a.type.constructor===Array)for(var c=a.type.length;c--;)b.drawArrays(a.type[c],0,a.number);else b.drawArrays(a.type,0,a.number)},G.prototype.saveImage=function(){var a,b=this.getTextureSize(),c=this.canvas.width,d=this.canvas.height;return this.resize(b.width,b.height),this.updateCamera(z()),a=this.canvas.toDataURL(),this.resize(c,d),this.updateCamera(),a},G.prototype.draw=function(){var a,b=this.gl,c=this.getScenes();for(b.clear(b.COLOR_BUFFER_BIT),a=0;a<c.length;a++)this.drawObject(c[a])},G.prototype.createSelect=function(){var a,b=this.gl,c=this.getBaseShader().select,d=Polyer.Utils.cloneObject(c.handlers);return this.setCurrentProgram(c.program),g(this,d.attributes,d.uniforms),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.setSelectObject(a={type:b.TRIANGLE_STRIP,number:4,shader:{program:c.program,handlers:d}}),a},G.prototype.addSelect=function(a,b){var c=this.getSelectObject()||this.createSelect(),d=p(this,a,b),e=c.shader.handlers.attributes.position.buffer[0];e[0]=e[6]=d.x,e[1]=e[4]=d.y,this.updateSingleCamera(c),this.addToScene(c)},G.prototype.updateSelect=function(a,b){var c,d,e,f,g,h,i=this.getSelectObject(),j=this.getPolyPointObject(),k=i.shader.handlers.attributes.position.buffer[0],l=j&&j.shader.handlers.uniforms.selectSquare;d=p(this,a,b),c={x:k[0],y:k[1]},k[3]=k[9]=d.x,k[7]=k[10]=d.y,c.x>d.x?(e=c.x,f=d.x):(e=d.x,f=c.x),c.y>d.y?(g=c.y,h=d.y):(g=d.y,h=c.y),l.buffer=[f,e,h,g],this.draw()},G.prototype.deleteSelectedPoints=function(a,b,c,d){var e,f=this.getPolyPoints();for(e=f.length;e--;)f[e][0]>a&&f[e][0]<b&&f[e][1]>c&&f[e][1]<d&&f.splice(e,1);this.updatePolyMeshBasePoints()},G.prototype.removeSelect=function(){var a,b=this.getScenes(),c=this.getSelectObject(),d=this.getPolyPointObject(),e=d.shader.handlers.uniforms.selectSquare,f=e.buffer,g=q(this,f[0],f[3],!0),h=q(this,f[1],f[2],!0);for(this.deleteSelectedPoints(g.x,h.x,g.y,h.y),e.buffer=G.Shaders.baseArgs.uniforms.selectSquare.buffer.slice(0),a=b.length;a--;)b[a]==c&&b.splice(a,1);this.draw()},G.prototype.updateViewport=function(){this.gl.viewport(0,0,this.canvas.width,this.canvas.height)},G.prototype.resize=function(a,b){var c,d,e,f,g,h,i,j=this.canvas,k=this.getScenes(),l=this.getTextureSize(),m=j.width,n=j.height,o=k.length;for(j.width=a,j.height=b,this.updateViewport(),e=m/a,f=n/b,h=m/n>l.width/l.height?n/l.height:m/l.width,a/b>l.width/l.height?(g=h/(b/l.height),this.setTextureSize(!1,l.width/l.height*b/a,1)):(g=h/(a/l.width),this.setTextureSize(!1,1,l.height/l.width*a/b)),e/=g,f/=g;o--;)for(i=k[o].shader.handlers.attributes.position.buffer[0],c=0,d=i.length;d>c;c+=3)i[c]*=e,i[c+1]*=f},G.prototype.zoom=function(a,b){var c=this.getCameraMatrix();c[0]-a>.2&&(c[0]-=a,c[5]-=b),this.updateCamera()},G.prototype.updateSingleCamera=function(a,b){a.shader.handlers.uniforms.cameraMatrix.buffer[0]=b||this.getCameraMatrix()},G.prototype.updateCamera=function(a){var b,c=this.getScenes();for(b=c.length;b--;)this.updateSingleCamera(c[b],a);this.draw()},G.prototype.drag=function(a,b){var c=this.getCameraMatrix();c[12]+=a,c[13]-=b,this.updateCamera()},G.prototype.bind=function(a){switch(a){case"mousewheel":C(this);break;case"drag":D(this);break;case"resize":F(this);break;case"click":E(this);break;default:console.error("no this event")}},G.prototype.bindEvents=function(a){for(var b=a.length;b--;)this.bind(a[b])},G.Shaders={baseArgs:{attributes:{position:{type:"float",size:3,buffer:[[-1,1,0,1,1,0,-1,-1,0,1,-1,0]]},uv:{type:"float",size:2,buffer:[[0,0,1,0,0,1,1,1]]},color:{type:"float",size:3,buffer:[null]}},uniforms:{isPoint:{type:"float",buffer:[null]},meshColor:{type:"vec3",buffer:[null]},cameraMatrix:{type:"mat4",buffer:[z()]},textureSize:{type:"vec2",buffer:[null]},selectSquare:{type:"vec4",buffer:[-2,2,2,2]}}},show:{vs:"attribute vec3 position;attribute vec2 uv;uniform mat4 cameraMatrix;varying vec2 t_uv;void main(){gl_Position = cameraMatrix * vec4(position, 1.0);t_uv = uv;}",fs:"precision mediump float;varying vec2 t_uv;uniform sampler2D texture;void main(){gl_FragColor = texture2D(texture, t_uv);}",handlers:{attributes:{position:"vec3",uv:"vec2"},uniforms:{cameraMatrix:"mat4"}}},select:{vs:"attribute vec3 position;uniform mat4 cameraMatrix;void main(){gl_Position = cameraMatrix * vec4(position, 1.0);}",fs:"precision mediump float;void main(){gl_FragColor = vec4(0.5294117647058824,0.807843137254902,0.9803921568627451,0.5);}",handlers:{attributes:{position:"vec3"},uniforms:{cameraMatrix:"mat4"}}},mesh:{vs:"attribute vec3 position;uniform mat4 cameraMatrix;varying vec3 vPosition;void main(){gl_Position = cameraMatrix * vec4(position, 1.0);vPosition = position;gl_PointSize = 4.0;}",fs:"precision mediump float;varying vec3 vPosition;uniform bool isPoint;uniform vec3 meshColor;uniform vec4 selectSquare;void main(){gl_FragColor = vec4(meshColor,1.0);if(isPoint && vPosition.x > selectSquare[0] && vPosition.x < selectSquare[1] && vPosition.y > selectSquare[2] && vPosition.y < selectSquare[3]){gl_FragColor = vec4(0.6294117647058824,0.907843137254902,0.9803921568627451,1.0);}}",handlers:{attributes:{position:"vec3"},uniforms:{isPoint:"bool",cameraMatrix:"mat4",meshColor:"vec3",selectSquare:"vec4"}}},"final":{vs:"attribute vec3 position;uniform mat4 cameraMatrix;attribute vec3 color;varying vec3 vColor;void main(){vColor = color;gl_Position = cameraMatrix * vec4(position, 1.0);}",fs:"precision mediump float;varying vec3 vColor;void main(){gl_FragColor = vec4(vColor,1.0);}",handlers:{attributes:{position:"vec3",color:"vec3"},uniforms:{cameraMatrix:"mat4"}}},gray:{vs:"attribute vec3 position;attribute vec2 uv;varying vec2 t_uv;void main(){gl_Position = vec4(position, 1.0);t_uv = uv;}",fs:"precision mediump float;varying vec2 t_uv;uniform sampler2D texture;void main(){vec4 temp = texture2D(texture,t_uv);float c = (max(temp.r,max(temp.g,temp.b)) + min(temp.r,min(temp.g,temp.b)))/4.0;gl_FragColor = vec4(c,c,c,1.0);}",handlers:{attributes:{position:"vec3",uv:"vec2"},uniforms:null}},common:{vsWithCamera:"attribute vec3 position;attribute vec2 uv;uniform mat4 cameraMatrix;varying vec2 t_uv;void main(){gl_Position = cameraMatrix * vec4(position, 1.0);t_uv = uv;}",vsWithoutCamera:"attribute vec3 position;attribute vec2 uv;varying vec2 t_uv;void main(){gl_Position = vec4(position, 1.0);t_uv = uv;}"},produceKernelFs:function(a,b){if(b%2===0||b>13||5>b)return console.error("The base size must be odd and ranged in [3,13]");if("edge"!=a&&"blur"!=a)return console.error("type must be edge or blur!");var c=b/2|0;return"precision mediump float;varying vec2 t_uv;uniform sampler2D texture;uniform vec2 textureSize;vec4 process(sampler2D t,vec2 v, vec2 o){vec4 temp = texture2D(t, v.xy + o.xy/textureSize);return temp;}void main() {const int len = "+b+";const int harf = "+c+";vec2 offset[len*len];for(int i = 0; i < len; i++){for(int j = 0; j < len; j++){offset[i*len+j] = vec2(float(j-harf),float(i-harf));}}float kernel[len*len];for(int i = 0; i < len;i++){for(int j = 0; j < len;j++){kernel[i*len + j] = "+("edge"==a?"i == harf && j == harf ? -float(len * len - 1) : 1.0;":"1.0;")+"}}vec4 sum = process(texture,t_uv,offset[0]) * kernel[0];for(int i = 1; i < len * len;i++){sum += process(texture,t_uv,offset[i]) * kernel[i];}"+("edge"==a?"if(sum.r > 0.1){ gl_FragColor = vec4(0.0,0.0,0.0,1.0);}else{ gl_FragColor = vec4(1.0,1.0,1.0,1.0);}":"gl_FragColor = sum / float(len * len);")+"}"}},(a.Polyer||(a.Polyer={})).WebGL=G}(window);